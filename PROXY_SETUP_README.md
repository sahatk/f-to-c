# Claude API 프록시 서버 설정 가이드

## 🔍 "Failed to fetch" 오류 원인 분석

"Failed to fetch" 오류는 다음과 같은 원인으로 발생할 수 있습니다:

### 1. **CORS 정책 문제**
- 브라우저의 Same-Origin Policy로 인한 API 호출 제한
- Figma 플러그인에서 외부 API 직접 호출 시 발생

### 2. **네트워크 방화벽 정책**
- 회사/기관 네트워크의 방화벽 설정
- 특정 도메인에 대한 접근 제한

### 3. **지역별 API 접근 제한**
- 일부 지역에서 Anthropic API 접근 제한
- ISP 레벨의 차단

### 4. **프록시 서버 필요성**
- 위의 문제들을 해결하기 위해 프록시 서버 사용
- 중간 서버를 통한 우회 연결

## 🚀 프록시 서버 구현 방법

### 방법 1: CORS 프록시 (가장 간단)

**장점**: 설정이 간단하고 무료
**단점**: 속도가 느리고 안정성 부족

```javascript
// 이미 구현되어 있음
// cors-anywhere.herokuapp.com 사용
```

### 방법 2: Cloudflare Workers (권장)

**장점**: 빠른 속도, 안정성, 무료 티어 제공
**단점**: 약간의 설정 필요

#### 설정 단계:
1. [Cloudflare Dashboard](https://dash.cloudflare.com/) 접속
2. Workers & Pages > Create application > Create Worker
3. `cloudflare-worker-proxy.js` 코드 복사하여 붙여넣기
4. Deploy 후 제공되는 URL 복사
5. 플러그인에서 프록시 방법을 "Cloudflare Workers"로 선택
6. 프록시 URL에 복사한 URL 입력

### 방법 3: Netlify Functions

**장점**: 무료 호스팅, 간단한 배포
**단점**: 콜드 스타트로 인한 초기 지연

#### 설정 단계:
1. [Netlify](https://netlify.com/) 계정 생성
2. 새 사이트 생성 (GitHub 연동 또는 수동 배포)
3. `netlify/functions/` 폴더 생성
4. `netlify-functions-proxy.js` 파일을 `claude-proxy.js`로 저장
5. 배포 후 `https://your-site.netlify.app/.netlify/functions/claude-proxy` URL 사용

### 방법 4: Vercel Functions

**장점**: 빠른 배포, 무료 티어
**단점**: 설정이 약간 복잡

### 방법 5: 자체 프록시 서버

**장점**: 완전한 제어, 보안
**단점**: 서버 비용, 유지보수 필요

## 🔧 플러그인에서 프록시 설정

### 1. 프록시 방법 선택
- 드롭다운에서 원하는 프록시 방법 선택
- "사용자 정의 프록시" 선택 시 URL 입력 필드 표시

### 2. 프록시 설정 저장
- "프록시 설정 저장" 버튼 클릭
- 설정이 자동으로 저장됨

### 3. 프록시 연결 테스트
- "프록시 연결 테스트" 버튼으로 연결 상태 확인
- 성공/실패 여부와 상태 코드 표시

## 📋 프록시 서버 요구사항

### 필수 기능:
- **CORS 헤더 지원**: `Access-Control-Allow-Origin: *`
- **POST 요청 처리**: Claude API 호출을 위한 POST 메서드
- **헤더 전달**: `x-api-key`, `anthropic-version` 헤더 지원
- **에러 처리**: 적절한 HTTP 상태 코드와 에러 메시지

### 보안 고려사항:
- API 키 노출 방지
- 요청 제한 및 속도 제한
- 로깅 및 모니터링

## 🚨 문제 해결

### 프록시 연결 실패 시:
1. **프록시 서버 상태 확인**: 프록시 서버가 정상 작동하는지 확인
2. **URL 형식 확인**: https://로 시작하는지 확인
3. **네트워크 설정 확인**: 방화벽이나 프록시 설정 확인
4. **대체 방법 시도**: 다른 프록시 방법으로 전환

### API 키 테스트 실패 시:
1. **프록시 설정 확인**: 올바른 프록시 방법이 선택되었는지 확인
2. **프록시 연결 테스트**: 프록시 서버 연결 상태 확인
3. **API 키 유효성**: Claude API 키가 올바른지 확인
4. **네트워크 환경**: 회사/기관 네트워크에서 프록시 필요 여부 확인

## 💡 권장 설정

### 개발 환경:
- **CORS 프록시**: 빠른 테스트용
- **Cloudflare Workers**: 안정적인 개발용

### 프로덕션 환경:
- **자체 프록시 서버**: 보안이 중요한 경우
- **Cloudflare Workers**: 비용 효율적인 경우

## 🔄 자동 재시도 메커니즘

플러그인은 다음과 같은 순서로 API 호출을 시도합니다:

1. **직접 호출**: Claude API에 직접 연결 시도
2. **주 프록시**: 선택된 프록시 방법으로 연결 시도
3. **대체 프록시**: CORS 프록시로 대체 시도
4. **에러 반환**: 모든 방법 실패 시 상세한 에러 메시지

이를 통해 네트워크 환경에 관계없이 최대한 안정적인 연결을 제공합니다.
