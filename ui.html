<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Claude Prompt Runner</title>
    <style>
      :root {
        --bg: #0b0c0f;
        --panel: #151821;
        --border: #2a2f3a;
        --text: #e6e8ee;
        --muted: #a7adbb;
        --accent: #6ea8fe;
        --accent-strong: #4c8dff;
        --danger: #ff5d5d;
        --success: #4caf50;
        --warning: #ffa726;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 16px;
        font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, Segoe UI,
          Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }
      .section {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 12px;
      }
      .section h2 {
        margin: 0 0 10px;
        font-size: 14px;
        color: var(--muted);
        font-weight: 600;
        letter-spacing: 0.2px;
      }
      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }
      input[type="password"],
      textarea {
        width: 100%;
        background: #0f121a;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 12px;
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .row + .row {
        margin-top: 8px;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      button:hover:not(:disabled) {
        background: var(--accent-strong);
      }
      button.secondary {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
      }
      button.secondary:hover:not(:disabled) {
        background: var(--border);
      }
      button.analysis {
        background: var(--warning);
        color: #fff;
      }
      button.analysis:hover:not(:disabled) {
        background: #ff9800;
      }
      button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .status {
        font-size: 12px;
        margin-top: 8px;
        color: var(--muted);
      }
      .status.success {
        color: var(--success);
      }
      .status.error {
        color: var(--danger);
      }
      .status.warning {
        color: var(--warning);
      }
      .result-box {
        background: #0f121a;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        max-height: 220px;
        overflow: auto;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }
      .split {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        align-items: center;
      }
      .workflow-indicator {
        background: #1a1d29;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px 12px;
        margin: 8px 0;
        font-size: 11px;
        color: var(--muted);
      }
      .workflow-indicator.active {
        background: #2d4a22;
        border-color: var(--success);
        color: var(--success);
      }
      .analysis-info {
        background: #2a2416;
        border: 1px solid #4a3c1a;
        border-radius: 6px;
        padding: 8px;
        margin: 8px 0;
        font-size: 11px;
        color: var(--warning);
      }
    </style>
  </head>
  <body>
    <div class="section" id="settings">
      <h2>API ì„¤ì •</h2>
      <label for="apiKey">Claude API í‚¤</label>
      <div class="row">
        <input type="password" id="apiKey" placeholder="sk-ant-api03..." />
      </div>
      <div class="row">
        <button id="saveKeyBtn">ì €ì¥</button>
        <button class="secondary" id="testKeyBtn">í…ŒìŠ¤íŠ¸</button>
        <span class="status" id="keyStatus"></span>
      </div>
    </div>

    <div class="section" id="proxySettings">
      <h2>í”„ë¡ì‹œ ì„œë²„ ì„¤ì •</h2>
      <label for="proxyMethod">í”„ë¡ì‹œ ë°©ë²• ì„ íƒ</label>
      <div class="row">
        <select id="proxyMethod">
          <option value="corsProxy">CORS í”„ë¡ì‹œ (cors-anywhere)</option>
          <option value="cloudflareProxy">Cloudflare Workers</option>
          <option value="customProxy">ì‚¬ìš©ì ì •ì˜ í”„ë¡ì‹œ</option>
          <option value="netlifyProxy" selected>Netlify Functions</option>
          <option value="vercelProxy">Vercel Functions</option>
        </select>
      </div>
      <div class="row" id="customProxyRow" style="display: none">
        <input
          type="text"
          id="customProxyUrl"
          placeholder="https://your-proxy-server.com/claude/"
        />
      </div>
      <div class="row">
        <button class="secondary" id="saveProxyBtn">í”„ë¡ì‹œ ì„¤ì • ì €ì¥</button>
        <button class="secondary" id="testProxyBtn">í”„ë¡ì‹œ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        <span class="status" id="proxyStatus"></span>
      </div>
      <div class="analysis-info" id="proxyInfo">
        <strong>ğŸ’¡ í”„ë¡ì‹œ ì„œë²„ ì‚¬ìš© ì´ìœ :</strong>
        <div style="margin-top: 8px; font-size: 10px; line-height: 1.4">
          â€¢ CORS ì •ì±…ìœ¼ë¡œ ì¸í•œ ì§ì ‘ API í˜¸ì¶œ ì œí•œ
          <br />
          â€¢ íšŒì‚¬/ê¸°ê´€ ë„¤íŠ¸ì›Œí¬ì˜ ë°©í™”ë²½ ì •ì±…
          <br />
          â€¢ ì§€ì—­ë³„ API ì ‘ê·¼ ì œí•œ
          <br />
          â€¢ í”„ë¡ì‹œë¥¼ í†µí•œ ìš°íšŒ ì—°ê²°
        </div>
      </div>
    </div>

    <div class="section" id="prompt">
      <h2>í”„ë¡¬í”„íŠ¸</h2>
      <label for="promptInput">ëª…ë ¹ ì…ë ¥</label>
      <textarea
        id="promptInput"
        placeholder="í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
      ></textarea>
      <div class="split" style="margin-top: 8px">
        <div class="row">
          <button id="runBtn">ì‹¤í–‰</button>
          <button class="secondary" id="clearBtn">ì§€ìš°ê¸°</button>
        </div>
        <span class="status" id="runStatus"></span>
      </div>
      <div class="row" style="margin-top: 8px">
        <div class="result-box" id="result"></div>
      </div>
    </div>

    <div class="section" id="mcp">
      <h2>MCP ë°ì´í„°</h2>
      <div class="workflow-indicator" id="workflowStep1">
        1ë‹¨ê³„: Figma ì„ íƒ ì˜ì—­ â†’ MCP ë°ì´í„° ìƒì„±
      </div>
      <div class="split" style="margin-top: 8px">
        <div class="row">
          <button id="mcpBtn">ì„ íƒ â†’ MCP ë°ì´í„° ìƒì„±</button>
        </div>
        <span class="status" id="mcpStatus"></span>
      </div>
      <div class="row" style="margin-top: 8px">
        <div class="result-box" id="mcpResult"></div>
      </div>
    </div>

    <div class="section" id="htmlSection">
      <h2>HTML ì½”ë“œ ê²°ê³¼</h2>
      <div class="workflow-indicator" id="workflowStep2">
        2ë‹¨ê³„: MCP ë°ì´í„° â†’ HTML ì½”ë“œ ìƒì„±
      </div>
      <div class="analysis-info" id="htmlAnalysisInfo" style="display: none">
        <strong>ğŸ” HTML êµ¬ì¡° ë¶„ì„ ê²°ê³¼:</strong>
        <div
          id="htmlAnalysisResult"
          style="margin-top: 8px; font-size: 10px; line-height: 1.4"
        ></div>
      </div>
      <div class="split" style="margin-top: 8px">
        <div class="row">
          <button class="secondary" id="mcpHtmlBtn">Claudeë¡œ HTML ìƒì„±</button>
          <button class="secondary" id="analyzeStructureBtn">êµ¬ì¡° ë¶„ì„</button>
          <button class="secondary" id="copyHtmlBtn">HTML ë³µì‚¬</button>
        </div>
        <span class="status" id="htmlStatus"></span>
      </div>
      <div class="row" style="margin-top: 8px">
        <div class="result-box" id="htmlResult"></div>
      </div>
    </div>

    <div class="section" id="scssSection">
      <h2>SCSS ì½”ë“œ ê²°ê³¼</h2>
      <div class="workflow-indicator" id="workflowStep3">
        3ë‹¨ê³„: HTML + MCP ë°ì´í„° â†’ SCSS ì½”ë“œ ìƒì„±
      </div>
      <div class="analysis-info" id="analysisInfo" style="display: none">
        ğŸ” HTML êµ¬ì¡°ì™€ MCP ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì •í™•í•œ SCSSë¥¼ ìƒì„±í•©ë‹ˆë‹¤. HTMLì˜
        í´ë˜ìŠ¤ëª…ê³¼ MCPì˜ ìŠ¤íƒ€ì¼ ì •ë³´ê°€ ìë™ìœ¼ë¡œ ë§¤ì¹­ë©ë‹ˆë‹¤.
      </div>
      <div class="split" style="margin-top: 8px">
        <div class="row">
          <button class="secondary" id="mcpScssBtn">Claudeë¡œ SCSS ìƒì„±</button>
          <button class="analysis" id="analyzeHtmlBtn">HTML ë¶„ì„ â†’ SCSS</button>
          <button class="secondary" id="copyScssBtn">SCSS ë³µì‚¬</button>
        </div>
        <span class="status" id="scssStatus"></span>
      </div>
      <div class="row" style="margin-top: 8px">
        <div class="result-box" id="scssResult"></div>
      </div>
    </div>

    <script>
      const apiKeyInput = document.getElementById("apiKey");
      const saveKeyBtn = document.getElementById("saveKeyBtn");
      const testKeyBtn = document.getElementById("testKeyBtn");
      const keyStatus = document.getElementById("keyStatus");

      const promptInput = document.getElementById("promptInput");
      const runBtn = document.getElementById("runBtn");
      const clearBtn = document.getElementById("clearBtn");
      const runStatus = document.getElementById("runStatus");
      const resultBox = document.getElementById("result");
      const mcpBtn = document.getElementById("mcpBtn");
      const mcpStatus = document.getElementById("mcpStatus");
      const mcpResult = document.getElementById("mcpResult");
      const mcpHtmlBtn = document.getElementById("mcpHtmlBtn");
      const mcpScssBtn = document.getElementById("mcpScssBtn");
      const analyzeHtmlBtn = document.getElementById("analyzeHtmlBtn");
      const analyzeStructureBtn = document.getElementById(
        "analyzeStructureBtn"
      );
      const htmlStatus = document.getElementById("htmlStatus");
      const scssStatus = document.getElementById("scssStatus");
      const htmlResult = document.getElementById("htmlResult");
      const scssResult = document.getElementById("scssResult");
      const copyHtmlBtn = document.getElementById("copyHtmlBtn");
      const copyScssBtn = document.getElementById("copyScssBtn");
      const analysisInfo = document.getElementById("analysisInfo");
      const htmlAnalysisInfo = document.getElementById("htmlAnalysisInfo");
      const htmlAnalysisResult = document.getElementById("htmlAnalysisResult");

      // í”„ë¡ì‹œ ì„¤ì • ê´€ë ¨ ìš”ì†Œë“¤
      const proxyMethod = document.getElementById("proxyMethod");
      const customProxyRow = document.getElementById("customProxyRow");
      const customProxyUrl = document.getElementById("customProxyUrl");
      const saveProxyBtn = document.getElementById("saveProxyBtn");
      const testProxyBtn = document.getElementById("testProxyBtn");
      const proxyStatus = document.getElementById("proxyStatus");

      // ì›Œí¬í”Œë¡œìš° ì¸ë””ì¼€ì´í„° ìš”ì†Œë“¤
      const workflowStep1 = document.getElementById("workflowStep1");
      const workflowStep2 = document.getElementById("workflowStep2");
      const workflowStep3 = document.getElementById("workflowStep3");

      function post(message) {
        parent.postMessage({ pluginMessage: message }, "*");
      }

      function setKeyStatus(text, type) {
        keyStatus.textContent = text || "";
        keyStatus.className = "status" + (type ? " " + type : "");
      }

      function setRunStatus(text, type) {
        runStatus.textContent = text || "";
        runStatus.className = "status" + (type ? " " + type : "");
      }

      function setBusy(isBusy) {
        saveKeyBtn.disabled = isBusy;
        testKeyBtn.disabled = isBusy;
        runBtn.disabled = isBusy;
        if (mcpBtn) mcpBtn.disabled = isBusy;
        if (mcpHtmlBtn) mcpHtmlBtn.disabled = isBusy;
        if (mcpScssBtn) mcpScssBtn.disabled = isBusy;
        if (analyzeHtmlBtn) analyzeHtmlBtn.disabled = isBusy;
        if (analyzeStructureBtn) analyzeStructureBtn.disabled = isBusy;
        if (saveProxyBtn) saveProxyBtn.disabled = isBusy;
        if (testProxyBtn) testProxyBtn.disabled = isBusy;
      }

      function setMcpStatus(text, type) {
        mcpStatus.textContent = text || "";
        mcpStatus.className = "status" + (type ? " " + type : "");
      }

      function setProxyStatus(text, type) {
        proxyStatus.textContent = text || "";
        proxyStatus.className = "status" + (type ? " " + type : "");
      }

      function updateWorkflowIndicators() {
        // MCP ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        const hasMcpData = mcpResult.textContent.trim().length > 0;
        const hasHtmlCode = htmlResult.textContent.trim().length > 0;
        const hasScssCode = scssResult.textContent.trim().length > 0;

        // ë‹¨ê³„ë³„ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        workflowStep1.className = hasMcpData
          ? "workflow-indicator active"
          : "workflow-indicator";
        workflowStep2.className = hasHtmlCode
          ? "workflow-indicator active"
          : "workflow-indicator";
        workflowStep3.className = hasScssCode
          ? "workflow-indicator active"
          : "workflow-indicator";

        // HTML ë¶„ì„ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        if (hasHtmlCode && hasMcpData) {
          analyzeHtmlBtn.style.display = "inline-block";
          analysisInfo.style.display = "block";
        } else {
          analyzeHtmlBtn.style.display = "none";
          analysisInfo.style.display = "none";
        }
      }

      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        switch (msg.type) {
          case "apiKeyValue": {
            apiKeyInput.value = msg.apiKey || "";
            break;
          }
          case "apiKeySaved": {
            setBusy(false);
            if (msg.ok === false) {
              setKeyStatus("ì €ì¥ ì‹¤íŒ¨: " + (msg.error || "ì˜¤ë¥˜"), "error");
            } else {
              // persisted=falseë¼ë©´ clientStorageëŠ” ì‹¤íŒ¨í–ˆìœ¼ë‚˜ ë¡œì»¬ ì €ì¥ì€ ì„±ê³µí•œ ìƒíƒœ
              if (msg.persisted === false && msg.warning) {
                setKeyStatus(
                  "ë¡œì»¬ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (í´ë¼ìš°ë“œ ì €ì¥ ë¶ˆê°€) â€” " +
                    msg.warning,
                  "success"
                );
              } else {
                setKeyStatus("API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
              }
            }
            break;
          }
          case "apiKeyTestResult": {
            setBusy(false);
            if (msg.ok) setKeyStatus("API í‚¤ í…ŒìŠ¤íŠ¸ ì„±ê³µ", "success");
            else
              setKeyStatus(
                "API í‚¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: " + (msg.error || "ì˜¤ë¥˜"),
                "error"
              );
            break;
          }
          case "proxySettingsSaved": {
            setBusy(false);
            if (msg.ok) {
              setProxyStatus("í”„ë¡ì‹œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            } else {
              setProxyStatus(
                "í”„ë¡ì‹œ ì„¤ì • ì €ì¥ ì‹¤íŒ¨: " + (msg.error || "ì˜¤ë¥˜"),
                "error"
              );
            }
            break;
          }
          case "proxySettingsLoaded": {
            if (msg.ok && msg.settings) {
              proxyMethod.value = msg.settings.method || "netlifyProxy";
              if (msg.settings.customUrl) {
                customProxyUrl.value = msg.settings.customUrl;
              }
              updateCustomProxyRow();
            }
            break;
          }
          case "proxyConnectionTestResult": {
            setBusy(false);
            if (msg.ok) {
              setProxyStatus(`í”„ë¡ì‹œ ì—°ê²° ì„±ê³µ (${msg.status})`, "success");
            } else {
              setProxyStatus(
                "í”„ë¡ì‹œ ì—°ê²° ì‹¤íŒ¨: " + (msg.error || "ì˜¤ë¥˜"),
                "error"
              );
            }
            break;
          }
          case "promptResult": {
            setBusy(false);
            if (msg.ok) {
              resultBox.textContent = msg.text || "";
              setRunStatus("ì™„ë£Œ", "success");
            } else {
              resultBox.textContent = "";
              setRunStatus("ì‹¤íŒ¨: " + (msg.error || "ì˜¤ë¥˜"), "error");
            }
            break;
          }
          case "mcpDataResult": {
            setBusy(false);
            if (msg.ok) {
              mcpResult.textContent = msg.json || "";
              setMcpStatus("ìƒì„± ì™„ë£Œ", "success");
            } else {
              mcpResult.textContent = "";
              setMcpStatus("ì‹¤íŒ¨: " + (msg.error || "ì˜¤ë¥˜"), "error");
            }
            updateWorkflowIndicators();
            break;
          }
          case "claudeHtmlResult": {
            setBusy(false);
            if (msg.ok) {
              htmlResult.textContent = msg.code || "";
              htmlStatus.textContent = "ì™„ë£Œ";
              htmlStatus.className = "status success";

              // HTML êµ¬ì¡° ë¶„ì„ ì •ë³´ í‘œì‹œ
              if (msg.analysis) {
                htmlAnalysisResult.textContent = msg.analysis;
                htmlAnalysisInfo.style.display = "block";
              }
            } else {
              htmlResult.textContent = "";
              htmlStatus.textContent = "ì‹¤íŒ¨: " + (msg.error || "ì˜¤ë¥˜");
              htmlStatus.className = "status error";
              htmlAnalysisInfo.style.display = "none";
            }
            updateWorkflowIndicators();
            break;
          }
          case "claudeScssResult": {
            setBusy(false);
            if (msg.ok) {
              scssResult.textContent = msg.code || "";
              scssStatus.textContent = "ì™„ë£Œ";
              scssStatus.className = "status success";
            } else {
              scssResult.textContent = "";
              scssStatus.textContent = "ì‹¤íŒ¨: " + (msg.error || "ì˜¤ë¥˜");
              scssStatus.className = "status error";
            }
            updateWorkflowIndicators();
            break;
          }
          default:
            break;
        }
      };

      // Load saved key on init
      try {
        const localKey = localStorage.getItem("claude_api_key") || "";
        if (localKey) apiKeyInput.value = localKey;
      } catch (e) {}
      post({ type: "getApiKey" });

      saveKeyBtn.addEventListener("click", () => {
        const apiKey = (apiKeyInput.value || "").trim();
        if (!apiKey) {
          setKeyStatus("API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "error");
          return;
        }
        setBusy(true);
        setKeyStatus("ì €ì¥ ì¤‘...", "");
        try {
          localStorage.setItem("claude_api_key", apiKey);
        } catch (e) {}
        post({ type: "setApiKey", apiKey });
      });

      testKeyBtn.addEventListener("click", () => {
        const apiKey = (apiKeyInput.value || "").trim();
        if (!apiKey) {
          setKeyStatus("API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "error");
          return;
        }
        setBusy(true);
        setKeyStatus("í…ŒìŠ¤íŠ¸ ì¤‘...", "");
        post({ type: "testApiKey", apiKey });
      });

      runBtn.addEventListener("click", () => {
        const prompt = (promptInput.value || "").trim();
        if (!prompt) {
          setRunStatus("í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "error");
          return;
        }
        setBusy(true);
        setRunStatus("ì‹¤í–‰ ì¤‘...", "");
        const apiKey = (apiKeyInput.value || "").trim();
        post({ type: "runPrompt", prompt, apiKey });
      });

      clearBtn.addEventListener("click", () => {
        promptInput.value = "";
        resultBox.textContent = "";
        setRunStatus("", "");
      });

      // MCP ë²„íŠ¼: ì„ íƒ ì˜ì—­ì„ MCP JSONìœ¼ë¡œ ë³€í™˜ ìš”ì²­
      if (mcpBtn) {
        mcpBtn.addEventListener("click", () => {
          setBusy(true);
          setMcpStatus("ìƒì„± ì¤‘...", "");
          mcpResult.textContent = "";
          post({ type: "generateMcpData" });
        });
      }

      if (mcpHtmlBtn) {
        mcpHtmlBtn.addEventListener("click", () => {
          setBusy(true);
          htmlResult.textContent = "";
          htmlStatus.textContent = "ìƒì„± ì¤‘...";
          htmlStatus.className = "status";
          const apiKey = (apiKeyInput.value || "").trim();
          const userPrompt = (promptInput.value || "").trim();
          post({ type: "claudeGenerateHtml", apiKey, userPrompt });
        });
      }

      if (mcpScssBtn) {
        mcpScssBtn.addEventListener("click", () => {
          setBusy(true);
          scssResult.textContent = "";
          scssStatus.textContent = "ìƒì„± ì¤‘...";
          scssStatus.className = "status";
          const apiKey = (apiKeyInput.value || "").trim();
          const userPrompt = (promptInput.value || "").trim();
          post({ type: "claudeGenerateScss", apiKey, userPrompt });
        });
      }

      // HTML ë¶„ì„ì„ í†µí•œ SCSS ìƒì„± ë²„íŠ¼
      if (analyzeHtmlBtn) {
        analyzeHtmlBtn.addEventListener("click", () => {
          const htmlCode = htmlResult.textContent.trim();
          if (!htmlCode) {
            scssStatus.textContent = "HTML ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
            scssStatus.className = "status error";
            return;
          }

          setBusy(true);
          scssResult.textContent = "";
          scssStatus.textContent = "HTML ë¶„ì„ ì¤‘...";
          scssStatus.className = "status warning";

          const apiKey = (apiKeyInput.value || "").trim();
          const userPrompt = (promptInput.value || "").trim();
          post({
            type: "analyzeHtmlForScss",
            apiKey,
            userPrompt,
            htmlCode,
          });
        });
      }

      // HTML êµ¬ì¡° ë¶„ì„ ë²„íŠ¼
      if (analyzeStructureBtn) {
        analyzeStructureBtn.addEventListener("click", () => {
          const mcpData = mcpResult.textContent.trim();
          if (!mcpData) {
            htmlStatus.textContent = "MCP ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
            htmlStatus.className = "status error";
            return;
          }

          try {
            setBusy(true);
            htmlStatus.textContent = "êµ¬ì¡° ë¶„ì„ ì¤‘...";
            htmlStatus.className = "status warning";

            post({ type: "analyzeMcpStructure" });
          } catch (e) {
            htmlStatus.textContent = "ë¶„ì„ ì‹¤íŒ¨";
            htmlStatus.className = "status error";
            setBusy(false);
          }
        });
      }

      if (copyHtmlBtn) {
        copyHtmlBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(htmlResult.textContent || "");
            htmlStatus.textContent = "ë³µì‚¬ë¨";
            htmlStatus.className = "status success";
          } catch (e) {
            htmlStatus.textContent = "ë³µì‚¬ ì‹¤íŒ¨";
            htmlStatus.className = "status error";
          }
        });
      }

      if (copyScssBtn) {
        copyScssBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(scssResult.textContent || "");
            scssStatus.textContent = "ë³µì‚¬ë¨";
            scssStatus.className = "status success";
          } catch (e) {
            scssStatus.textContent = "ë³µì‚¬ ì‹¤íŒ¨";
            scssStatus.className = "status error";
          }
        });
      }

      // í”„ë¡ì‹œ ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
      function updateCustomProxyRow() {
        if (proxyMethod.value === "customProxy") {
          customProxyRow.style.display = "block";
        } else {
          customProxyRow.style.display = "none";
        }
      }

      // í”„ë¡ì‹œ ë°©ë²• ë³€ê²½ ì‹œ ì‚¬ìš©ì ì •ì˜ í”„ë¡ì‹œ URL ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
      if (proxyMethod) {
        proxyMethod.addEventListener("change", updateCustomProxyRow);
      }

      // í”„ë¡ì‹œ ì„¤ì • ì €ì¥ ë²„íŠ¼
      if (saveProxyBtn) {
        saveProxyBtn.addEventListener("click", () => {
          const method = proxyMethod.value;
          const customUrl =
            method === "customProxy" ? customProxyUrl.value.trim() : "";

          if (method === "customProxy" && !customUrl) {
            setProxyStatus("ì‚¬ìš©ì ì •ì˜ í”„ë¡ì‹œ URLì„ ì…ë ¥í•˜ì„¸ìš”.", "error");
            return;
          }

          setBusy(true);
          setProxyStatus("í”„ë¡ì‹œ ì„¤ì • ì €ì¥ ì¤‘...", "");
          post({ type: "saveProxySettings", method, customUrl });
        });
      }

      // í”„ë¡ì‹œ ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼
      if (testProxyBtn) {
        testProxyBtn.addEventListener("click", () => {
          const method = proxyMethod.value;
          setBusy(true);
          setProxyStatus("í”„ë¡ì‹œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...", "");
          post({ type: "testProxyConnection", proxyMethod: method });
        });
      }

      // ì´ˆê¸° í”„ë¡ì‹œ ì„¤ì • ë¡œë“œ
      post({ type: "loadProxySettings" });

      // ê¸°ë³¸ê°’ ì„¤ì • (ì„¤ì •ì´ ì—†ì„ ê²½ìš°)
      if (proxyMethod) {
        proxyMethod.value = "netlifyProxy";
        updateCustomProxyRow();
      }

      // ì´ˆê¸° ì›Œí¬í”Œë¡œìš° ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
      updateWorkflowIndicators();
    </script>
  </body>
</html>
